name: üêß Build Portable MLIR Toolchain

on:
  workflow_call:
    inputs:
      llvm-project-ref:
        description: "llvm-project ref or tag (e.g., llvmorg-21.1.8)"
        required: true
        type: string
      build-type:
        description: "Build type (Release or Debug)"
        required: false
        default: "Release"
        type: string

permissions:
  contents: read

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        runs-on: [ubuntu-24.04, ubuntu-24.04-arm]
    runs-on: ${{ matrix.runs-on }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Validate build-type
        run: |
          if [[ "${{ inputs.build-type }}" != "Release" && "${{ inputs.build-type }}" != "Debug" ]]; then
            echo "Error: build-type must be 'Release' or 'Debug', got '${{ inputs.build-type }}'"
            exit 1
          fi
      - name: Setup rmz
        run: |
          ARCH=$(uname -m)
          if [[ "$ARCH" == "x86_64" ]]; then
            URL_ARCH="x86_64"
          elif [[ "$ARCH" == "aarch64" || "$ARCH" == "arm64" ]]; then
            URL_ARCH="aarch64"
          else
            echo "Unsupported architecture: $ARCH"
            exit 1
          fi

          OS=$(uname -s)
          if [[ "$OS" == "Linux" ]]; then
            URL_OS="unknown-linux-gnu"
          elif [[ "$OS" == "Darwin" ]]; then
            URL_OS="apple-darwin"
          else
            echo "Unsupported OS: $OS"
            exit 1
          fi

          DOWNLOAD_URL="https://github.com/SUPERCILEX/fuc/releases/download/3.1.1/${URL_ARCH}-${URL_OS}-rmz"
          curl -L -o rmz "$DOWNLOAD_URL"
          chmod +x rmz
          sudo mv rmz /usr/bin/rmz
          rmz --version
      - name: Disk usage (before cleanup)
        run: |
          set -euo pipefail
          echo "== df -h (/ and /mnt) =="
          df -h / /mnt || true
          echo
          echo "== df -m (/ and /mnt) =="
          df -m / /mnt || true
      - name: Free up some space
        run: |
          set -euo pipefail

          # Remove Docker images, build cache, and volumes
          docker system prune -af --volumes || true
          docker builder prune -af || true

          # apt cleanup
          sudo apt-get -qq -y remove --purge \
            '^apache2.*' \
            '^aspnetcore-.*' \
            azure-cli \
            buildah \
            '^byobu.*' \
            '^clang-.*' \
            containerd.io \
            containernetworking-plugins \
            '^dotnet-.*' \
            firefox \
            '^fonts-.*' \
            fwupd \
            '^gfortran-.*' \
            '^google-.*' \
            '^gradle.*' \
            '^java.*' \
            '^kotlin.*' \
            kubectl \
            '^libclang-.*' \
            libgl1-mesa-dri \
            '^libgirepository-.*' \
            '^libgtk-.*' \
            '^libllvm-.*' \
            '^libx265-.*' \
            '^llvm-.*' \
            man-db \
            manpages \
            manpages-dev \
            '^mecab.*' \
            mediainfo \
            '^mercurial.*' \
            microsoft-edge-stable \
            '^mongodb-.*' \
            '^mono-.*' \
            '^mssql-.*' \
            '^mysql-.*' \
            '^nginx-.*' \
            '^php.*' \
            '^podman.*' \
            '^powershell.*' \
            '^postgres.*' \
            python-babel-localedata \
            '^python3-babel.*' \
            '^python3-boto.*' \
            '^ruby.*' \
            '^r-base.*' \
            skopeo \
            snapd \
            tcl \
            tk \
            '^tex-.*' \
            '^vim.*'

          sudo apt-get autoremove -qq -y
          sudo apt-get clean -qq

          sudo rmz -f \
            "${AGENT_TOOLSDIRECTORY}" \
            "${HOME}/.rustup" \
            "${HOME}/.cargo" \
            "${HOME}/.dotnet" \
            "${HOME}/linuxbrew" \
            "${HOME}/snap" \
            /opt/containerd \
            /opt/hostedtoolcache \
            /opt/microsoft \
            /opt/az \
            /opt/ghc \
            /opt/pipx* \
            /opt/google \
            /opt/microsoft \
            /opt/mssql-tools \
            /snap \
            /usr/bin/kotlin* \
            /usr/lib/heroku \
            /usr/lib/jvm \
            /usr/lib/snapd \
            /usr/local/.ghcup \
            /usr/local/aws-cli \
            /usr/local/julia* \
            /usr/local/lib/android \
            /usr/local/lib/node_modules \
            /usr/local/share/chromium \
            /usr/local/share/nvm \
            /usr/local/share/selenium \
            /usr/local/share/vcpkg \
            /usr/share/apache-* \
            /usr/share/az_* \
            /usr/share/doc/* \
            /usr/share/dotnet \
            /usr/share/fonts/* \
            /usr/share/gradle-* \
            /usr/share/icons/* \
            /usr/share/info/* \
            /usr/share/kotlinc \
            /usr/share/java \
            /usr/share/man/* \
            /usr/share/miniconda \
            /usr/share/sbt \
            /usr/share/swift \
            /usr/share/tcltk \
            /usr/share/texinfo \
            /var/cache/apt/* \
            /var/lib/apache2 \
            /var/lib/apt/lists/* \
            /var/lib/containerd \
            /var/lib/gems \
            /var/lib/mysql \
            /var/lib/snapd \
            /var/lib/ubuntu-advantage \
            /var/snap
      - name: Disk usage (after cleanup)
        run: |
          set -euo pipefail
          echo "== df -h (/ and /mnt) =="
          df -h / /mnt || true
          echo
          echo "== df -m (/ and /mnt) =="
          df -m / /mnt || true
      - name: Build
        run: |
          DEBUG_FLAG=""
          if [[ "${{ inputs.build-type }}" == "Debug" ]]; then
            DEBUG_FLAG="-d"
          fi
          bash ${{ github.workspace }}/scripts/toolchain/linux/build.sh -r ${{ inputs.llvm-project-ref }} -p ${{ github.workspace }}/llvm-install ${DEBUG_FLAG}
      - name: Upload archive
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ matrix.runs-on }}-${{ inputs.build-type }}-archive
          path: llvm-mlir_*.tar.zst
          if-no-files-found: error
